// Update the form submission in add-app.html
document.getElementById('appForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // ... (previous validation code)
    
    // Prepare app data
    const appData = {
        name: document.getElementById('name').value.trim(),
        description: document.getElementById('description').value.trim(),
        version: document.getElementById('version').value.trim(),
        size: document.getElementById('size').value.trim(),
        category: 'tools', // Default category
        requirements: 'Android 5.0+',
        features: document.getElementById('features').value.trim().split('\n').filter(f => f.trim()),
        downloads: 0,
        featured: false,
        rating: 0
    };
    
    // Handle file uploads
    const logoFile = logoInput.files[0];
    const apkFile = apkInput.files[0];
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
        
        let logoUrl = '';
        let apkUrl = '';
        
        // Upload files to Firebase Storage if online
        if (typeof FirebaseApp !== 'undefined' && window.adminPanel && window.adminPanel.isOnline) {
            if (logoFile) {
                logoUrl = await FirebaseApp.uploadFile(logoFile, `logos/${Date.now()}_${logoFile.name}`);
                appData.logo = logoUrl;
            }
            
            if (apkFile) {
                apkUrl = await FirebaseApp.uploadFile(apkFile, `apks/${Date.now()}_${apkFile.name}`);
                appData.apk_file = apkUrl;
            }
            
            // Save to Firebase
            const newApp = await FirebaseApp.addApp(appData);
            
            // Also save to localStorage for offline backup
            let userApps = JSON.parse(localStorage.getItem('user_apps') || '[]');
            userApps.push({ id: newApp.id, ...appData });
            localStorage.setItem('user_apps', JSON.stringify(userApps));
            
            showMessage(`üéâ ‡§ê‡§™ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!<br><strong>${appData.name}</strong> ‡§Ö‡§¨ ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§™‡§∞ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à`, 'success');
            
        } else {
            // Offline mode - save to localStorage only
            const newId = 'local_' + Date.now();
            appData.id = newId;
            appData.logo = URL.createObjectURL(logoFile);
            appData.apk_file = URL.createObjectURL(apkFile);
            appData.created_at = new Date().toISOString();
            
            let userApps = JSON.parse(localStorage.getItem('user_apps') || '[]');
            userApps.push(appData);
            localStorage.setItem('user_apps', JSON.stringify(userApps));
            
            showMessage(`üéâ ‡§ê‡§™ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ! (Offline Mode)<br><strong>${appData.name}</strong> Local Storage ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•Å‡§Ü`, 'success');
        }
        
        // Reset form
        document.getElementById('appForm').reset();
        logoPreview.style.display = 'none';
        apkInfo.style.display = 'none';
        updateCounters();
        
        // Redirect to dashboard
        setTimeout(() => {
            window.location.href = 'dashboard.html';
        }, 3000);
        
    } catch (error) {
        showMessage(`‡§Ö‡§™‡§≤‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`, 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-plus"></i> ‡§ê‡§™ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç';
    }
});