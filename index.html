<!-- Add Firebase scripts in head -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<!-- Your scripts -->
<script src="assets/js/firebase-config.js"></script>
<script src="assets/js/script.js"></script>
<script src="assets/js/apps-data.js"></script>

<script>
    // Updated loadApps function
    document.addEventListener('DOMContentLoaded', async function() {
        await loadApps();
    });

    async function loadApps() {
        const apps = await loadAppsData();
        
        // Cache apps for offline use
        localStorage.setItem('cached_apps', JSON.stringify(apps));
        
        displayFeaturedApps(apps);
        displayAllApps(apps);
        updateStats(apps);
        setupCategoryFilters();
    }

    function displayFeaturedApps(allApps) {
        const container = document.getElementById('featuredApps');
        if (!container) return;

        // Get featured apps or first 6 apps
        const featured = allApps.filter(app => app.featured).slice(0, 6);
        if (featured.length === 0) {
            featured = allApps.slice(0, 6);
        }
        
        container.innerHTML = featured.map(app => `
            <div class="app-card" data-category="${app.category || 'all'}" data-id="${app.id}">
                <img src="${app.logo}" alt="${app.name}" onerror="this.src='assets/img/default-logo.png'">
                <h3>${app.name}</h3>
                <p>${app.description ? app.description.substring(0, 100) + '...' : ''}</p>
                <div class="app-info">
                    <span><i class="fas fa-code-branch"></i> ${app.version || '1.0'}</span>
                    <span><i class="fas fa-hdd"></i> ${app.size || 'N/A'}</span>
                    <span><i class="fas fa-download"></i> ${formatNumber(app.downloads || 0)}</span>
                </div>
                <a href="download.html?id=${app.id}" class="btn-download" onclick="trackDownload('${app.id}')">
                    <i class="fas fa-download"></i> डाउनलोड APK
                </a>
            </div>
        `).join('');
    }

    async function trackDownload(appId) {
        try {
            // Increment download count in Firebase
            if (typeof FirebaseApp !== 'undefined') {
                await FirebaseApp.incrementDownloads(appId);
            }
            
            // Update in localStorage cache
            let cachedApps = JSON.parse(localStorage.getItem('cached_apps') || '[]');
            const appIndex = cachedApps.findIndex(app => app.id === appId);
            if (appIndex !== -1) {
                cachedApps[appIndex].downloads = (cachedApps[appIndex].downloads || 0) + 1;
                localStorage.setItem('cached_apps', JSON.stringify(cachedApps));
            }
            
            // Update today's count
            const today = new Date().toDateString();
            const todayKey = `daily_downloads_${today}`;
            let todayCount = parseInt(localStorage.getItem(todayKey) || '0');
            localStorage.setItem(todayKey, todayCount + 1);
            
        } catch (error) {
            console.error('Error tracking download:', error);
        }
    }

    // Update trackDownload globally
    window.trackDownload = trackDownload;
</script>